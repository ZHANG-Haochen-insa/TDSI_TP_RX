# X射线成像实验完整指南

## 一、实验目的

1. 熟悉X射线成像设备的操作
2. 理解并验证**比尔-朗伯定律**（Beer-Lambert Law）
3. 掌握图像校正技术：暗电流校正、平场校正（Flat Field）
4. 研究X射线管电压对成像的影响

---

## 二、理论背景

### 核心公式：比尔-朗伯定律

$$n(x,y) = n_0 \exp\left(-\int \mu(x,y) \, dl\right)$$

| 符号 | 含义 |
|------|------|
| $s(x,y)$ | 相机测量的信号（与光子数成正比） |
| $n(x,y)$ | 到达探测器的X射线光子数 |
| $n_0$ | 入射到物体上的光子数 |
| $\mu$ | 物体的线性衰减系数 (cm⁻¹) |
| $\tau$ | 质量衰减系数 (cm²/g) |
| $\rho$ | 质量密度 (g/cm³) |

**关系式**：$\mu = \tau \cdot \rho$

---

## 三、实验设备

### 3.1 硬件设备
- X射线发生器（带预热功能）
- X射线管
- 探测器（相机）
- 样品架（高度可调，需设置为25mm）
- 电源控制器（可调电压和电流）

### 3.2 可用样品

| 编号 | 样品名称 | 用途 |
|------|----------|------|
| 物体0 | 无（空） | 平场校正参考 |
| 物体1 | 纸板阶梯 | 验证比尔-朗伯定律 |
| 物体2 | 小球 | 一般成像 |
| 物体3 | 铝制阶梯 | 金属衰减研究 |
| 物体4 | 泡沫 | 低密度材料成像 |
| 物体5 | 核桃 | 复杂结构成像 |

### 3.3 软件工具
- **PSL Viewer**：图像采集软件
- **Python程序**：`code_etu.py`、`code_2_etu.py`、`meanMultipleRois_etu.py`
- **XmuDat**：质量衰减系数查询软件

---

## 四、实验步骤详解

### A部分：设备初始化与熟悉操作

#### 步骤A.1：登录系统
- 打开"学生"（Etudiant）会话

#### 步骤A.2：启动X射线发生器
- 打开X射线发生器电源
- 启动X射线管预热程序
- 参考文档：`.\documentation\TutoRX.pdf`（幻灯片2-3）

#### 步骤A.3：启动PSL Viewer
- 双击桌面快捷方式启动

#### 步骤A.4：配置相机设置
点击"camera setup"，**禁用所有自动处理**：
- [ ] Background（取消勾选）
- [ ] FlatField（取消勾选）
- [ ] BrightPixel（取消勾选）
- [ ] NoiseReduction（取消勾选）
- [ ] Offset（取消勾选）
- [ ] Sharpening（取消勾选）

#### 步骤A.5：设置采集参数
- 在"Exposure"中选择采集时间
- 使用实时预览按钮观察图像

---

### B部分：第一批图像采集

#### 步骤B.1：识别设备组件
定位以下组件：
- X射线管位置
- 探测器位置
- 样品架位置
- X射线管电源装置

#### 步骤B.2：放置样品
- 将样品(a)放置在样品架上
- 确认高度位置：**25mm**（参见图2b）
- 检查距离：
  - X射线管-探测器距离（参考导轨黄色标记）
  - X射线管-样品架距离（参考导轨黄色标记）

#### 步骤B.3：设置X射线参数
- **电压（Beam Voltage）**：30 kV
- **电流（Beam Current）**：250 mA
- 操作：按住"set"按钮进行调节

#### 步骤B.4：设置采集时间
- PSL Viewer > Camera setup > Exposure
- 设置为：**1秒（1000 ms）**

#### 步骤B.5：开启X射线
- 按下"X-Rays ON/OFF"按钮
- X射线管开始连续发射

> **警告**：不采集图像时，务必关闭X射线管以保护探测器！

---

### 问题Q1-Q2：基础观察

#### [Q1] 观察并保存图像
**任务**：
1. 观察获得的图像
2. 理解图像的可视化方式（使用对应按钮调整）
3. 保存图像

**输出文件**：`Q1.tif`

**注意**：如果图像显示为"黑色"：
- 这不代表采集失败
- 打开图像查看实际数值
- 可能是显示范围问题

#### [Q2] 分析对比度来源
**思考题**：对比度的物理起源是什么？

**答案要点**：
- 不同材料对X射线的衰减系数不同
- 不同厚度导致不同的衰减量
- 根据比尔-朗伯定律，衰减取决于 $\int \mu \, dl$

---

### C部分：X射线管电流和积分时间研究

#### [Q3] 不同采集时间的图像采集

**任务**：采集5个不同曝光时间的图像

| 序号 | 采集时间 | 输出文件名 |
|------|----------|------------|
| 1 | 100 ms | Q3_0100.tif |
| 2 | 500 ms | Q3_0500.tif |
| 3 | 1000 ms | Q3_1000.tif |
| 4 | 2000 ms | Q3_2000.tif |
| 5 | 4000 ms | Q3_4000.tif |

**方法**：编写采集宏
- 参考示例：`.\macro_acqui\simpleExample.txt`
- 参考文档：`.\documentation\PSLViewerManual.pdf`（第27-32页，Macro control部分）
- 主要命令：`expose`（曝光）和 `saveas`（保存）

**启动宏的步骤**：
1. 选择MacroControl窗口
2. 点击 start macro
3. 选择你的宏文件
4. 点击 start

**输出文件**：
- 宏文件：`Q3_macro.txt`
- 图像文件：`Q3_0100.tif` ~ `Q3_4000.tif`

#### [Q4] 推导信号与时间的关系

**思考题**：根据公式(1)，采集时间对光子数有什么影响？

**答案要点**：
- 光子数与采集时间成正比
- 简单关系：$s = k \cdot t$（k为常数）
- 或更完整：$s(t) = s_0 \cdot t$

#### [Q5] 样品架后区域分析

**任务**：分析图3中红色实线标记的"样品架后区域"

**思考题**：
1. Q4提出的线性关系在该区域是否成立？
2. 样品架强烈衰减X射线，理论上该区域应测量到什么值？
3. 实际测量到什么值？

**答案要点**：
- 理论上应该接近0（完全衰减）
- 实际测量到非零值
- 这是**暗电流（Dark Current）**造成的
- 暗电流是探测器在无X射线照射时产生的信号

#### [Q6] 暗电流校正

**任务**：
1. 提出暗电流校正方法
2. 采集额外的校正图像
3. 完成Python代码（`code_etu.py`中的Q6单元格）

**校正方法**：
1. 关闭X射线（或完全遮挡）
2. 采集同样曝光时间的"暗场图像"
3. 校正公式：$s_{corrected} = s_{raw} - s_{dark}$

**输出文件**：`Q5_*.tif`（*替换为你选择的名称，如`Q5_dark_1000ms.tif`）

#### [Q7] 验证校正效果

**任务**：
1. 验证校正后的图像与积分时间成正比
2. 计算两张图像的比值（如4s和1s）
3. 完成Python代码

**验证方法**：
- 计算 $\frac{s(4s)}{s(1s)}$
- 如果校正正确，比值应该接近4

**输出文件**：
- `Q7_1000ms.tif`（校正后的1秒图像）
- `Q7_4000ms.tif`（校正后的4秒图像）
- `Q7_div.tif`（除法结果）

---

### D部分：平场校正（Flat Field Correction）

#### [Q8] 分析空间变化

**任务**：观察校正图像Q7_1000ms.tif和Q7_4000ms.tif在**样品外区域**（图3蓝色虚线）的外观

**思考题**：
1. 观察到什么现象？（空间亮度变化）
2. 物理解释是什么？

**答案要点**：
- 图像边缘比中心暗（或有渐变）
- 原因：
  - X射线源的空间强度分布不均匀
  - 探测器灵敏度的空间变化
  - X射线束的几何发散

#### [Q9] 平场校正原理

**任务**：提出校正方法，消除空间变化的探测增益

**校正方法**：
1. 移除所有样品
2. 采集"平场参考图像"（flat field image）
3. 校正公式：

$$s_{flat-corrected}(x,y) = \frac{s_{object}(x,y) - s_{dark}(x,y)}{s_{flat}(x,y) - s_{dark}(x,y)}$$

**物理理解**：
- $s_{flat}$ 代表探测器对均匀照射的响应
- 除以它可以消除空间不均匀性

#### [Q10] 实现平场校正

**任务**：
1. 采集无样品的参考图像
2. 在Python中实现校正函数
3. 应用校正并保存结果

**操作步骤**：
1. 移除样品架上的所有物体
2. 保持相同的X射线参数（30kV, 250mA）
3. 采集1000ms曝光的平场图像
4. 编写校正函数
5. 对之前的图像应用校正

**输出文件**：
- `Q9_1000ms.tif`（无样品的平场参考图像）
- `Q10_1000ms.tif`（平场校正后的1秒图像）
- `Q10_2000ms.tif`（平场校正后的2秒图像）

---

### E部分：比尔-朗伯定律验证

#### [Q11] 选择验证样品

**思考题**：为了验证比尔-朗伯定律中衰减 $\int \mu \, dl$ 的演变，需要使用不同厚度的已知材料，应该选择哪个样品？

**答案**：**物体1 - 纸板阶梯**

**原因**：
- 阶梯提供了多个已知的、递增的厚度
- 材料均匀，衰减系数一致
- 可以测量衰减随厚度的变化

#### [Q11b] 采集阶梯图像

**设置**：
- 电压：30 kV
- 电流：250 mA
- **重要**：放置后不要移动样品！

**输出文件**：
- `Q11.tif`（原始图像）
- `Q11_b.tif`（平场校正后的图像）

#### [Q12] 绘制衰减-厚度关系图

**任务**：
1. 修改并完善 `meanMultipleRois_etu.py` 代码
2. 在每个阶梯区域选择ROI（感兴趣区域）
3. 计算每个区域的平均衰减值
4. 绘制衰减与厚度的关系图

**衰减计算**：
$$Attenuation = -\ln\left(\frac{s_{object}}{s_{flat}}\right) = \int \mu \, dl$$

**输出文件**：
- `Q12.tif`（平场校正后的阶梯图像）
- `Q12_plot.tif`（衰减-厚度关系图）

#### [Q13] 分析衰减演变

**思考题**：衰减如何随厚度变化？

**答案要点**：
- 衰减与厚度呈**线性关系**
- 斜率等于线性衰减系数 $\mu$
- 验证了比尔-朗伯定律：$\int \mu \, dl = \mu \cdot x$（均匀材料）

#### [Q14] 估算质量衰减系数

**任务**：估算纸板的质量衰减系数 $\tau$（单位：cm²/g）

**已知条件**：
- 纸板克重（grammage）：$\sigma = 240 \, g/m^2$
- 关系式：$\mu = \tau \cdot \rho$

**推导**：
设单层纸板厚度为 $\Delta x$，则：
- $\rho \cdot \Delta x = \sigma$（面密度）
- $\mu \cdot \Delta x = \tau \cdot \rho \cdot \Delta x = \tau \cdot \sigma$

因此：
$$\tau = \frac{\mu \cdot \Delta x}{\sigma} = \frac{\Delta(\text{衰减})}{\sigma}$$

**注意**：不需要知道 $\Delta x$ 的具体值！

#### [Q15] 与理论值比较

**任务**：
1. 使用XmuDat软件查询理论值
2. 比较实验值与理论值
3. 推导"有效"采集能量

**XmuDat操作步骤**：
1. File > Data setup > Add
2. 选择 Cellulose Acetate（醋酸纤维素，模拟纸板）
3. Rel. Weight = 1
4. OK, OK 查看质量衰减系数曲线
5. File > Save Data 保存数据

**分析**：
- 找到实验测得的 $\tau$ 值对应的能量
- 这就是系统的"有效能量"

---

### F部分：X射线管电压的影响

#### 实验设置

对以下三个电压重复E部分的实验：
- **25 kV**
- **20 kV**
- **15 kV**

**重要**：不要移动样品！

#### [Q17] 分析不同电压下的平场校正问题

**观察任务**：观察不同电压下平场校正后的图像

**可能出现的问题**：
- 低电压时平场图像与高电压时不同
- 需要为每个电压单独采集平场参考图像

**解决方法**：
- 在每个电压设置下，分别采集对应的平场参考图像
- 使用匹配的平场图像进行校正

**输出文件**：
- `Q17_15kV.tif`
- `Q17_20kV.tif`
- `Q17_25kV.tif`

#### [Q18] 分析衰减与能量的关系

**思考题**：衰减如何随X射线能量变化？

**答案要点**：
- 低能X射线被物质吸收更强
- 衰减系数 $\mu$ 随能量增加而**减小**
- 这符合光电效应的能量依赖性（大致正比于 $E^{-3}$）

---

## 五、需要提交的文件清单

### 5.1 图像文件（.tif格式）

| 问题 | 文件名 | 说明 |
|------|--------|------|
| Q1 | Q1.tif | 初始观察图像 |
| Q3 | Q3_0100.tif | 100ms曝光 |
| Q3 | Q3_0500.tif | 500ms曝光 |
| Q3 | Q3_1000.tif | 1000ms曝光 |
| Q3 | Q3_2000.tif | 2000ms曝光 |
| Q3 | Q3_4000.tif | 4000ms曝光 |
| Q6 | Q5_*.tif | 暗场校正图像 |
| Q7 | Q7_1000ms.tif | 暗场校正后1s图像 |
| Q7 | Q7_4000ms.tif | 暗场校正后4s图像 |
| Q7 | Q7_div.tif | 除法结果 |
| Q10 | Q9_1000ms.tif | 无样品平场参考 |
| Q10 | Q10_1000ms.tif | 平场校正后1s图像 |
| Q10 | Q10_2000ms.tif | 平场校正后2s图像 |
| Q11 | Q11.tif | 阶梯原始图像 |
| Q11 | Q11_b.tif | 阶梯平场校正图像 |
| Q12 | Q12.tif | 阶梯处理后图像 |
| Q12 | Q12_plot.tif | 衰减-厚度关系图 |
| Q17 | Q17_15kV.tif | 15kV校正图像 |
| Q17 | Q17_20kV.tif | 20kV校正图像 |
| Q17 | Q17_25kV.tif | 25kV校正图像 |

### 5.2 代码和宏文件

| 文件名 | 说明 |
|--------|------|
| Q3_macro.txt | 采集宏脚本 |
| code_etu.py | 主要Python代码（需完成Q6、Q7等单元格） |
| code_2_etu.py | 第二个Python代码文件 |
| meanMultipleRois_etu.py | ROI分析代码（需修改完善） |

---

## 六、重要注意事项

### 安全须知
1. **不采集时必须关闭X射线管**，保护探测器
2. 遵守实验室X射线安全规程
3. 不要直接接触X射线束路径

### 实验技巧
1. E部分和F部分：**不要移动样品**，便于后续处理
2. 图像显示"黑色"时，检查实际像素值
3. 每次更改电压后，需要重新采集对应的平场参考图像
4. 保存图像前确认文件名正确

### 图像区域定义（参见图3）
- **蓝色虚线区域**：样品外部区域（用于评估均匀性）
- **红色实线区域**：样品架后面的区域（用于评估暗电流）

---

## 七、参考文档

| 文档 | 路径 | 内容 |
|------|------|------|
| X射线教程 | `.\documentation\TutoRX.pdf` | 设备操作指南 |
| PSL Viewer手册 | `.\documentation\PSLViewerManual.pdf` | 软件使用说明，特别是宏控制（p.27-32） |
| 宏示例 | `.\macro_acqui\simpleExample.txt` | 采集宏编写参考 |

---

*文档版本：基于2023年12月11日实验指导书整理*
